<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pln√° moc ‚Äì podpis</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
label { display:block; margin-top:10px; font-weight:bold; }
input { width:100%; padding:8px; }
button { padding:10px 14px; margin-top:15px; cursor:pointer; }
#sigPanel { display:none; margin-top:20px; }
canvas { border:1px dashed #0a58ff; width:100%; height:260px; }
</style>
</head>
<body>

<h2>N√°hƒæad dokumentu</h2>
<embed src="template.pdf" width="100%" height="520px" type="application/pdf">

<h2>Vypl≈àte √∫daje</h2>

<label>Meno a priezvisko</label>
<input id="i_name">

<label>Trval√Ω pobyt</label>
<input id="i_addr">

<label>Rodn√© ƒç√≠slo</label>
<input id="i_rc">

<label>Miesto podp√≠sania</label>
<input id="i_place">

<label>D√°tum</label>
<input id="i_date" type="date">

<label>Email klienta (voliteƒæn√©)</label>
<input id="i_client_email">

<button onclick="showSignature()">üñäÔ∏è Podp√≠sa≈•</button>

<div id="sigPanel">
<h3>Podpis</h3>
<p>Podp√≠≈°te sa na ƒçiaru:</p>
<div style="border-bottom:2px solid black; width:80%; margin:0 auto 10px auto;"></div>
<canvas id="sigPad"></canvas>
<button onclick="clearPad()">Vymaza≈• podpis</button>
<button onclick="confirmSignature()">Potvrdi≈• podpis</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

<script>
emailjs.init("BDiw7IJQiDnlCYFPX");

let signaturePad = null;
let finalSignature = null;

function showSignature(){
    document.getElementById("sigPanel").style.display = "block";
    const canvas = document.getElementById("sigPad");
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    signaturePad = new SignaturePad(canvas, {
        penColor: "#0a58ff",
        minWidth: 1.2,
        maxWidth: 2.6
    });
}

function clearPad(){ signaturePad.clear(); }

async function confirmSignature(){
    if(signaturePad.isEmpty()){
        alert("Pros√≠m, podp√≠≈°te sa.");
        return;
    }
    finalSignature = signaturePad.toDataURL();
    await generatePDF();
}

async function generatePDF(){
    const existingPdfBytes = await fetch("template.pdf").then(r => r.arrayBuffer());
    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
    const page = pdfDoc.getPages()[0];
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

    function draw(text, x, y){
        page.drawText(text, { x, y, size: 11, font });
    }

    // ‚úÖ Polia splnomocniteƒæa ‚Äì veƒæmi presn√© umiestnenie
    draw(i_name.value, 150, 650);
    draw(i_addr.value, 150, 630);
    draw(i_rc.value,   150, 610);

    draw(i_place.value, 150, 510);

    if(i_date.value){
        const d = i_date.value.split("-");
        draw(d[2]+"."+d[1]+"."+d[0], 320, 510);
    }

    // ‚úÖ Klientov podpis medzi "Splnomocnenec" a bodkovan√∫ ƒçiaru
    const sig = await pdfDoc.embedPng(finalSignature);
    page.drawImage(sig, {
        x: 370,     // presne nad pravou bodkovanou ƒçiarou
        y: 455,     // medzi text a ƒçiaru
        width: 160,
        height: 70
    });

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    window.open(url, "_blank");

    const pdfBase64 = btoa(String.fromCharCode(...new Uint8Array(pdfBytes)));

    emailjs.send("service_gnniw7e", "template_184peha", {
        client_email: i_client_email.value.trim(),
        agent_email: "m.sunok@protonmail.com",
        pdf_file: pdfBase64,
        client_name: i_name.value
    });

    alert("‚úÖ Vygenerovan√© a odoslan√©.");
}
</script>

</body>
</html>
